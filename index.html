<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coordinates Tracker</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- SheetJS (XLSX) Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Leaflet CSS for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+M3b/2v4ZgkJymj+c+zIBtrHjOAd9Gg4WsM6Pnu9g=" crossorigin=""/>
  <style>
    body {
      background: linear-gradient(135deg, #74ebd5, #ACB6E5);
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 20px;
      transition: background 0.5s;
    }
    .container {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 1000px;
      width: 100%;
      transition: background 0.5s, color 0.5s;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-weight: bold;
      color: #333;
    }
    .instructions {
      margin-top: 20px;
      font-size: 0.95rem;
      background: #f1f1f1;
      padding: 15px;
      border-radius: 8px;
      color: #333;
    }
    .btn {
      transition: transform 0.2s ease-in-out;
    }
    .btn:hover {
      transform: scale(1.03);
    }
    /* Style for the default dropdown option */
    option[disabled][selected] {
      color: #6c757d;
    }
    #map {
      height: 300px;
      border-radius: 8px;
      margin-top: 20px;
    }
    /* Dark Mode Adjustments */
    .dark-mode {
      background: #333;
      color: #eee;
    }
    .dark-mode .container {
      background: #444;
      color: #eee;
    }
    .dark-mode .form-control,
    .dark-mode .form-select {
      background: #666;
      color: #eee;
      border-color: #888;
    }
    .dark-mode .instructions {
      background: #555;
      color: #eee;
    }
    .dark-mode table {
      color: #eee;
    }
    .dark-mode .table-light {
      background-color: #666;
    }
  </style>
</head>
<body>
  <div class="container animate__animated animate__fadeInDown">
    <header class="header">
      <h1>Coordinates Tracker</h1>
      <p class="lead">Capture your coordinates automatically</p>
      <button id="toggleDarkMode" class="btn btn-outline-secondary btn-sm">
        <i class="fa-solid fa-moon"></i> Toggle Dark Mode
      </button>
    </header>
    
    <!-- Form Section -->
    <section>
      <form id="coordinatesForm">
        <div class="mb-3">
          <label for="excelFile" class="form-label">Upload Excel File (Optional)</label>
          <input class="form-control" type="file" id="excelFile" accept=".xlsx,.xls">
        </div>
        <div class="mb-3">
          <label for="idType" class="form-label">ID Category</label>
          <select class="form-select" id="idType">
            <option value="" disabled selected>Choose Category</option>
            <option value="Customer Dial">Customer Dial</option>
            <option value="Pop Name">Pop Name</option>
            <option value="Cabinet Number">Cabinet Number</option>
            <option value="Enterprise Line ID">Enterprise Line ID</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="idValue" class="form-label">Enter Value</label>
          <input type="text" class="form-control" id="idValue" placeholder="Enter the corresponding value">
        </div>
        <div class="mb-3">
          <label class="form-label">Location</label>
          <div class="row g-2">
            <div class="col-4">
              <input type="text" class="form-control" id="latitude" placeholder="Latitude" readonly>
            </div>
            <div class="col-4">
              <input type="text" class="form-control" id="longitude" placeholder="Longitude" readonly>
            </div>
            <div class="col-4">
              <input type="text" class="form-control" id="accuracy" placeholder="Accuracy (m)" readonly>
            </div>
          </div>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button type="button" id="addLocationBtn" class="btn btn-primary">
            <i class="fa-solid fa-location-arrow"></i> Add Location
          </button>
        </div>
        <div class="d-flex gap-2 mb-3">
          <button type="button" id="downloadExcelBtn" class="btn btn-success flex-fill">
            <i class="fa-solid fa-file-excel"></i> Download Excel
          </button>
          <button type="button" id="clearBtn" class="btn btn-secondary flex-fill">
            <i class="fa-solid fa-eraser"></i> Clear Fields
          </button>
        </div>
      </form>
    </section>
    
    <!-- Map Section -->
    <section id="mapSection" style="display: none;">
      <h5>Location Map</h5>
      <div id="map"></div>
    </section>
    
    <!-- Recent Locations Table -->
    <section class="mt-4">
      <h5>Recent Locations</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="locationsTable">
          <thead class="table-light">
            <tr>
              <th>ID Category</th>
              <th>ID Value</th>
              <th>Date</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Accuracy (m)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data rows inserted here -->
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- Instructions Section -->
    <section class="instructions">
      <h5>Instructions</h5>
      <ol>
        <li><strong>Upload Excel File (Optional):</strong> Load an existing Excel file if available. Otherwise, a new file will be created.</li>
        <li><strong>Select ID Category and Enter Value:</strong> Choose a category (using the dropdown that starts with "Choose Category") and input the corresponding value.</li>
        <li><strong>Add Location:</strong> Click the <strong>Add Location</strong> button to capture your current coordinates along with accuracy and date/time. The location will be displayed on the map and added to the recent locations table.</li>
        <li><strong>Download Excel:</strong> Click <strong>Download Excel</strong> to save the updated file. The file will be named as CT_&lt;date&gt; (e.g., CT_4-2-2025.xlsx).</li>
        <li><strong>Clear Fields:</strong> Use the <strong>Clear Fields</strong> button to reset the form inputs without affecting the recorded Excel data.</li>
      </ol>
    </section>
    
    <section id="feedback" class="mt-4"></section>
  </div>
  
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS for map -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7qST9z3n1qf4o7p2cHfS7kgtKepJDX1pGgInWM=" crossorigin=""></script>
  
  <script>
    // Global variable to hold Excel data (2D array for SheetJS)
    let workbookData = [];
    const headers = ["ID Category", "ID Value", "Date", "Latitude", "Longitude", "Accuracy (m)"];
    let fileUploaded = false;
    
    // Load saved locations from localStorage if available; otherwise initialize with headers
    if(localStorage.getItem('locationsData')) {
      workbookData = JSON.parse(localStorage.getItem('locationsData'));
    } else {
      workbookData = [headers];
    }
    
    // Update the recent locations table and persist data
    function updateLocationsTable() {
      const tableBody = document.querySelector("#locationsTable tbody");
      tableBody.innerHTML = "";
      // Loop starting at 1 to skip headers
      for(let i = 1; i < workbookData.length; i++){
        const row = workbookData[i];
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      }
      // Save only the workbookData array (including header) to localStorage
      localStorage.setItem('locationsData', JSON.stringify(workbookData));
    }
    
    updateLocationsTable();
    
    // Display feedback messages with animation
    function showFeedback(message, type) {
      const feedbackDiv = document.getElementById('feedback');
      feedbackDiv.innerHTML = `<div class="alert alert-${type} animate__animated animate__fadeIn">${message}</div>`;
    }
    
    // Initialize Leaflet map to display the captured location
    let map, marker;
    function initMap(lat, lng) {
      // Ensure numeric values
      lat = parseFloat(lat);
      lng = parseFloat(lng);
      if(!map) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(map);
      }
      if(marker) {
        marker.setLatLng([lat, lng]);
      } else {
        marker = L.marker([lat, lng]).addTo(map);
      }
      map.setView([lat, lng], 15);
    }
    
    // Handle Excel file upload if provided by the user
    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        workbookData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
        if (workbookData.length === 0) {
          workbookData = [headers];
        }
        fileUploaded = true;
        updateLocationsTable();
        showFeedback('Excel file loaded successfully!', 'success');
      };
      reader.readAsArrayBuffer(file);
    });
    
    // Add location: capture geolocation and update table & map
    document.getElementById('addLocationBtn').addEventListener('click', function() {
      const idCategory = document.getElementById('idType').value;
      if (!idCategory) {
        showFeedback('Please choose a category.', 'warning');
        return;
      }
      if (!navigator.geolocation) {
        showFeedback('Geolocation is not supported by this browser.', 'warning');
        return;
      }
      navigator.geolocation.getCurrentPosition(function(position) {
        const latitude = position.coords.latitude.toFixed(6);
        const longitude = position.coords.longitude.toFixed(6);
        const accuracy = position.coords.accuracy.toFixed(2);
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
        document.getElementById('accuracy').value = accuracy;
        
        const idValue = document.getElementById('idValue').value.trim();
        const currentDate = new Date().toLocaleString();
        const newRow = [idCategory, idValue, currentDate, latitude, longitude, accuracy];
        
        // Check if the last row is identical to the new row to avoid duplicates
        if(workbookData.length > 1) {
          const lastRow = workbookData[workbookData.length - 1];
          if(JSON.stringify(lastRow) === JSON.stringify(newRow)) {
            showFeedback("Duplicate location not added.", "warning");
            return;
          }
        }
        
        workbookData.push(newRow);
        updateLocationsTable();
        showFeedback('Location captured and added to the Excel data!', 'success');
        
        // Display the map section and update marker
        document.getElementById('mapSection').style.display = "block";
        initMap(latitude, longitude);
      }, function(error) {
        showFeedback('Error capturing location: ' + error.message, 'danger');
      });
    });
    
    // Download the Excel file with a dynamic filename (e.g. CT_4-2-2025.xlsx)
    document.getElementById('downloadExcelBtn').addEventListener('click', function() {
      const today = new Date();
      const fileName = `CT_${today.getMonth() + 1}-${today.getDate()}-${today.getFullYear()}.xlsx`;
      const newWorkbook = XLSX.utils.book_new();
      const newWorksheet = XLSX.utils.aoa_to_sheet(workbookData);
      XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Coordinates");
      XLSX.writeFile(newWorkbook, fileName);
    });
    
    // Clear only the form fields (without affecting saved data)
    document.getElementById('clearBtn').addEventListener('click', function() {
      document.getElementById('idValue').value = '';
      document.getElementById('idType').selectedIndex = 0;
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      document.getElementById('accuracy').value = '';
      showFeedback('Form fields have been cleared.', 'info');
    });
    
    // Toggle dark/light mode for the entire app
    document.getElementById('toggleDarkMode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const icon = this.querySelector('i');
      if(document.body.classList.contains('dark-mode')){
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
      }
    });
  </script>
</body>
</html>
